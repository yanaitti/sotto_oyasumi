<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>そっとおやすみ ONLINE</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
  </head>
  <body>
    <div id='app2'>
      <input id="cName_inp" placeholder="ニックネームを入力してください"><br/>
      <br/>
      <button id='createGame'>ゲームを作る(Make a Game)</button><br/>
      Game ID: <span id='gId'></span><br/>
      Game Status: <span id='gStatus'></span><br/>
      <hr/>
      <button id="joinGame">ゲームに参加する(Join the Game)</button><br/>
      <input id="gId_inp" placeholder="GameIDを入力してください"><br/>
      Your ID: <span id='cId'></span><br/>
      Your Name: <span id='cName'></span><br/>
      <hr/>
      <h2>Member Applying</h2>
      <span id='applyingList'></span>
      <br/>
      <div id='sec1' style='display:none'>
        <hr/>
        <button id="startGame">ゲームを始める(Let's start the Game)</button><br/>
      </div>
      <br/>
      <span id='message'></span><br/>
      <div id='sec2' style='display:none'>
        <h2>Member Rotation</h2>
        <span id='routeList'></span>
        <hr/>
        <table border="0" width="200" height="100">
          <tr align="center">
            <td id='tdcard0' valign="middle"><span id='card0'></span></td>
            <td id='tdcard1' valign="middle"><span id='card1'></span></td>
            <td id='tdcard2' valign="middle"><span id='card2'></span></td>
            <td id='tdcard3' valign="middle"><span id='card3'></span></td>
            <td id='tdcard4' valign="middle"><span id='card4'></span></td>
            <td id='tdcard5' valign="middle"><span id='card5'></span></td>
          </tr>
          <tr align="center">
            <td valign="middle"><input type='radio' name='area' id='rCard0'/></td>
            <td valign="middle"><input type='radio' name='area' id='rCard1'/></td>
            <td valign="middle"><input type='radio' name='area' id='rCard2'/></td>
            <td valign="middle"><input type='radio' name='area' id='rCard3'/></td>
            <td valign="middle"><input type='radio' name='area' id='rCard4'/></td>
            <td valign="middle"><input type='radio' name='area' id='rCard5'/></td>
          </tr>
        </table>
        <br/>
        <input type='button' id='nextPlayer' value='次のユーザに渡す' />
        <br/><br/>
        <input type='button' id='sleep' value='おやすみなさい' />
      </div>
      <div id='sec3' style='display:none'>
        <span id='sleptList'></span>
      </div>
    </div>
    <div style='display:none'>
      <img id='img0' src='img/pic0.jpg'/>
      <img id='img1' src='img/pic1.jpg'/>
      <img id='img2' src='img/pic2.jpg'/>
      <img id='img3' src='img/pic3.jpg'/>
      <img id='img5' src='img/pic5.jpg'/>
      <img id='img6' src='img/pic6.jpg'/>
      <img id='img7' src='img/pic7.jpg'/>
      <img id='img8' src='img/pic8.jpg'/>
      <img id='img10' src='img/pic10.jpg'/>
      <img id='img11' src='img/pic11.jpg'/>
      <img id='img12' src='img/pic12.jpg'/>
      <img id='img13' src='img/pic13.jpg'/>
      <img id='img15' src='img/pic15.jpg'/>
      <img id='img16' src='img/pic16.jpg'/>
      <img id='img17' src='img/pic17.jpg'/>
      <img id='img18' src='img/pic18.jpg'/>
      <img id='img20' src='img/pic20.jpg'/>
      <img id='img21' src='img/pic21.jpg'/>
      <img id='img22' src='img/pic22.jpg'/>
      <img id='img23' src='img/pic23.jpg'/>
      <img id='img25' src='img/pic25.jpg'/>
      <img id='img26' src='img/pic26.jpg'/>
      <img id='img27' src='img/pic27.jpg'/>
      <img id='img28' src='img/pic28.jpg'/>
      <img id='img30' src='img/pic30.jpg'/>
      <img id='img31' src='img/pic31.jpg'/>
      <img id='img32' src='img/pic32.jpg'/>
      <img id='img33' src='img/pic33.jpg'/>
      <img id='imgj' src='img/picj.jpg'/>
    </div>
    <script>
    var timeout = 1000;
    var timer = '';

    $(function() {
      var gId = '';
      var cId = '';

      // Create Game
      $('#createGame').click(function() {
        $('#message').empty();
        $.ajax('create' + '/' + $('#cName_inp').val(),
          {
            type: 'get',
          }
        )
        .done(function(data) {
          $('#gId').text(data);
          $('#cId').text(data);
          $('#cName').text($('#cName_inp').val());
          $('#gStatus').text('waiting');
          gId = data;
          cId = data;
          $('#sec1').show();
          timer = setTimeout(status_check(gId, cId), timeout)
        })
        .fail(function() {
          $('#message').text('エラーが発生しました');
        });
      });

      // Join Game
      $('#joinGame').click(function() {
        $('#message').empty();
        $.ajax($('#gId_inp').val() + '/join/' + $('#cName_inp').val(),
          {
            type: 'get',
          }
        )
        .done(function(data) {
          _tmp = data.split(' ,');
          $('#cId').text(_tmp[0]);
          $('#cName').text(_tmp[1]);
          $('#gStatus').text(_tmp[2]);
          gId = $('#gId_inp').val();
          cId = _tmp[0];
          timer = setTimeout(status_check(gId, cId), timeout)
        })
        .fail(function() {
          $('#message').text('エラーが発生しました');
        });
      });

      // Start Game
      $('#startGame').click(function() {
        $('#message').empty();
        $.getJSON(gId + '/start',
          {
            type: 'get',
          }
        )
        .done(function(data) {
          $("#sleep").attr('disabled', false);
        })
        .fail(function() {
          $('#message').text('エラーが発生しました');
        });
      });

      // Go to sleep
      $('#sleep').click(function() {
        $('#message').empty();
        // put your card
        $.ajax(gId + '/' + cId + '/sleep',
          {
            type: 'get',
          }
        )
        .done(function(data) {
          $('#message').text(data);
          $("#nextPlayer").attr('disabled', true);
          $("#sleep").attr('disabled', true);
          $('#sec3').show();
        })
        .fail(function() {
          $('#message').text('エラーが発生しました');
        });
      });

      // Next player
      $('#nextPlayer').click(function() {
        $('#message').empty();
        $.ajax(gId + '/' + cId + '/next/' + $('input[name="area"]:checked').val(),
          {
            type: 'get',
          }
        )
        .done(function(data) {
          // console.log(data)
          $('#message').text('次の人に移動しました');
          $('#nextPlayer').attr('disabled', true);
        })
        .fail(function() {
          $('#message').text('エラーが発生しました');
        });
      });
    });

    var status_check = function(gId, cId){
      setTimeout(function(){
        $('#message').empty();
        // all status
        $.getJSON(gId + '/status',
          {
            type: 'get',
          }
        )
        .done(function(data) {
          console.log(data)
          $('#gStatus').text(data.status);
          playerPos = 0;

          // Applying List
          $('#applyingList').empty();
          for(var pIdx in data.players){
            // console.log(data.players[pIdx])
            $('#applyingList').append(data.players[pIdx].nickname + '(' + data.players[pIdx].playerid + ')' + ',');
            if(cId == data.players[pIdx].playerid){
              playerPos = pIdx;
            }
          }

          if(data.status == 'started'){
            $('#sec2').show()
            // route List
            $('#routeList').empty();
            for(var rIdx in data.routelist){
              if(data.routelist[rIdx].playerid == data.routeid){
                $('#routeList').append('<b>&gt;' + data.routelist[rIdx].nickname + '</b><br/>');
              }else{
                $('#routeList').append(data.routelist[rIdx].nickname + '<br/>');
              }
            }

            // game cards
            holdcards = data.players[playerPos].holdcards;
            for(var i = 0; i < 6; i++){
              if(i < holdcards.length){

                // switch(Math.floor(holdcards[i] / 5)){
                switch(holdcards[i] % 5){
                  case 0:
                    $('#tdcard'+i).css("background-color","#e55050");
                    break;
                  case 1:
                    $('#tdcard'+i).css("background-color","#50b4e5");
                    break;
                  case 2:
                    $('#tdcard'+i).css("background-color","#e5b450");
                    break;
                  case 3:
                    $('#tdcard'+i).css("background-color","#50e550");
                    break;
                }
                if(holdcards[i] % 5 == 4){
                  $('#card'+i).text('J');
                  $('#tdcard'+i).css("background-color","#b450e5");
                }else{
                  $('#card'+i).text(Math.floor(holdcards[i] / 5));
                }
                $('#rCard'+i).val(holdcards[i]);
                $('#rCard'+i).show();
              }else{
                $('#card'+i).text('');
                $('#tdcard'+i).css("background-color","#fff");
                $('#rCard'+i).val('');
                $('#rCard'+i).css('display', 'none');
              }
            }

            $('#sleptList').text('')
            for(var sIdx in data.slept){
              $('#sleptList').append(data.slept[sIdx].nickname + ',');
            }

            // checking turn
            if(data.routeid == cId){
              $('#nextPlayer').attr('disabled', false)
              $('#sleep').attr('disabled', true)
            }else{
              $('#nextPlayer').attr('disabled', true)
              if(!data.players[playerPos].status){
                $('#sleep').attr('disabled', false)
              }else{
                $('#sleep').attr('disabled', true)
              }
            }
          }
        })
        .fail(function() {
          $('#message').text('エラーが発生しました');
        });
        timer = setTimeout(status_check(gId, cId), timeout)
      }, timeout);
    }
    //=====================================================
    // <img>要素 → Base64形式の文字列に変換
    //   img       : HTMLImageElement
    //   mime_type : string "image/png", "image/jpeg" など
    //=====================================================
    function ImageToBase64(img, mime_type) {
        // New Canvas
        var canvas = document.createElement('canvas');
        canvas.width  = img.width;
        canvas.height = img.height;
        // Draw Image
        var ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0);
        // To Base64
        return canvas.toDataURL(mime_type);
    }
    </script>
  </body>
</html>
